# å¿«é€Ÿå…¥é—¨

â€‹		æœ¬ç« æ˜¯ä¸€ä¸ª **Masa Framework** å¿«é€Ÿå…¥é—¨æ•™ç¨‹ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ **Masa Framework** åˆ›å»ºä¸€ä¸ªç®€å•çš„å¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºã€‚ä»¥ä¸‹æ˜¯ç¨‹åºæœ€ç»ˆè¿è¡Œæ•ˆæœï¼š

> ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½æˆ‘ä»¬å†™å¥½çš„æºç å»è¿è¡Œï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/MapleWithoutWords/MasaFramework-TodoApp

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230328231628904-1957534939.png)

## é¡¹ç›®ä¾èµ–

* å¼€å‘å·¥å…·ï¼šVisual Studioæˆ–å…¶å®ƒ
* .Netç‰ˆæœ¬ï¼š6.0+

## åˆ›å»ºé¡¹ç›®

1. ç¬¬ä¸€æ­¥ï¼šåœ¨ä¸€ä¸ªç©ºç›®å½•ä¸‹ä½¿ç”¨cmdè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå®ƒå°†ä¼šåˆ›å»ºæ•´ä¸ªé¡¹ç›®ï¼Œå¹¶æ·»åŠ é¡¹ç›®æ‰€éœ€è¦çš„NugetåŒ…ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨ **[Masa.Blazor](https://docs.masastack.com/blazor/getting-started/installation)**æ¥å®Œæˆæˆ‘ä»¬UIç•Œé¢ã€‚

```shell
dotnet new sln --name Masa.TodoApp
dotnet new web --name Masa.TodoApp.WebApi
dotnet sln add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj
dotnet new classlib --name Masa.TodoApp.Contracts
dotnet sln add .\Masa.TodoApp.Contracts\Masa.TodoApp.Contracts.csproj
dotnet new blazorserver-empty --name Masa.TodoApp.WebBalzor
dotnet sln add .\Masa.TodoApp.WebBalzor\Masa.TodoApp.WebBalzor.csproj
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj reference .\Masa.TodoApp.Contracts\Masa.TodoApp.Contracts.csproj
dotnet add .\Masa.TodoApp.WebBalzor\Masa.TodoApp.WebBalzor.csproj reference .\Masa.TodoApp.Contracts\Masa.TodoApp.Contracts.csproj
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.Data.EFCore.Sqlite -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.Data.Mapping.Mapster -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.Dispatcher.Events -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.ReadWriteSpliting.Cqrs -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.Service.MinimalAPIs -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Masa.Contrib.Exceptions -v 1.0.0-preview.22
dotnet add .\Masa.TodoApp.WebApi\Masa.TodoApp.WebApi.csproj package Swashbuckle.AspNetCore -v 6.5.0
dotnet add .\Masa.TodoApp.WebBalzor\Masa.TodoApp.WebBalzor.csproj package Masa.Blazor -v 1.0.0-preview.10
dotnet add .\Masa.TodoApp.WebBalzor\Masa.TodoApp.WebBalzor.csproj package Masa.Contrib.Service.Caller.HttpClient -v 1.0.0-preview.12

```

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329215836338-1165974933.png)

2. ç¬¬äºŒæ­¥ï¼šåŒå‡»slnæ–‡ä»¶ï¼Œæ‰“å¼€é¡¹ç›®ä¿®æ”¹ä»¥ä¸‹ç±»æ–‡ä»¶å†…å®¹ï¼Œå®Œæˆæˆ‘ä»¬çš„ç¨‹åºé…ç½®

   *  **```Masa.TodoApp.WebApi```**  é¡¹ç›®

     * ä¿®æ”¹ **```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„ **```Program.cs```** æ–‡ä»¶ã€‚å†…å®¹å¦‚ä¸‹ï¼š

     ```c#
     var builder = WebApplication.CreateBuilder(args);
     
     builder.Services.AddEventBus();
     builder.Services.AddMasaDbContext<TodoDbContext>(opt => opt.UseSqlite());
     builder.Services.AddMasaMinimalAPIs();
     //Swaggerä¾èµ–Endpointçš„ä¸€äº›æœåŠ¡ï¼Œå¿…é¡»AddEndpointsApiExplorerï¼Œä¸ç„¶swaggerä¸èƒ½ä½¿ç”¨
     builder.Services.AddEndpointsApiExplorer()
         .AddSwaggerGen(c =>
         {
             c.SwaggerDoc("v1", new OpenApiInfo
             {
                 Title = "TodoApp",
                 Version = "v1",
                 Contact = new OpenApiContact { Name = "TodoApp", }
             });
     
             foreach (var item in Directory.GetFiles(Directory.GetCurrentDirectory(), "*.xml"))
             {
                 c.IncludeXmlComments(item, true);
             }
             c.DocInclusionPredicate((docName, action) => true);
         });
     builder.Services.AddAutoInject();
     var app = builder.Build();
     
     app.UseMasaExceptionHandler();
     app.MapMasaMinimalAPIs();
     #region MigrationDb
     using var context = app.Services.CreateScope().ServiceProvider.GetService<TodoDbContext>();
     {
         if (context!.GetService<IRelationalDatabaseCreator>().HasTables()==false)
         {
             context.GetService<IRelationalDatabaseCreator>().CreateTables();
         }
     }
     #endregion
     app.UseSwagger().UseSwaggerUI(c => c.SwaggerEndpoint("/swagger/v1/swagger.json", "TodoApp"));
     app.Run();
     ```

     * ä¿®æ”¹ **```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„ **```appsettings.json```** æ–‡ä»¶ã€‚å†…å®¹å¦‚ä¸‹ï¼š

     ```json
     {
       "Logging": {
         "LogLevel": {
           "Default": "Information",
           "Microsoft.AspNetCore": "Warning"
         }
       },
       "AllowedHosts": "*",
       "ConnectionStrings": {
         "DefaultConnection": "Data Source=demodb.sqlite"
       }
     }
     ```

   * **```Masa.TodoApp.WebBalzor```**  é¡¹ç›®

     * ä¿®æ”¹**```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹çš„**```Pages/_Host.cshtml```**æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

     ```html
     @page "/"
     @using Microsoft.AspNetCore.Components.Web
     @namespace Masa.TodoApp.WebBalzor.Pages
     @addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
     
     <!DOCTYPE html>
     <html lang="en">
     <head>
         <meta charset="utf-8" />
         <base href="~/" />
         <link href="css/site.css" rel="stylesheet" />
         <!-- masa blazor css style -->
         <link href="_content/Masa.Blazor/css/masa-blazor.min.css" rel="stylesheet" />
     
         <!--icon file,import need to use-->
         <link href="https://cdn.masastack.com/npm/@("@mdi")/font@7.1.96/css/materialdesignicons.min.css" rel="stylesheet">
         <link href="https://cdn.masastack.com/npm/materialicons/materialicons.css" rel="stylesheet">
         <link href="https://cdn.masastack.com/npm/fontawesome/v5.0.13/css/all.css" rel="stylesheet">
     
         <!--js(should lay the end of file)-->
         <script src="_content/BlazorComponent/js/blazor-component.js"></script>
         <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
     </head>
     <body>
         <component type="typeof(App)" render-mode="ServerPrerendered" />
     
         <div id="blazor-error-ui">
             <environment include="Staging,Production">
                 An error has occurred. This application may no longer respond until reloaded.
             </environment>
             <environment include="Development">
                 An unhandled exception has occurred. See browser dev tools for details.
             </environment>
             <a href="" class="reload">Reload</a>
             <a class="dismiss">ğŸ—™</a>
         </div>
     
         <script src="_framework/blazor.server.js"></script>
     </body>
     </html>
     ```

     * ä¿®æ”¹**```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹çš„**```Program.cs```**æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

     ```c#
     var builder = WebApplication.CreateBuilder(args);
     builder.Services.AddRazorPages();
     builder.Services.AddServerSideBlazor();
     builder.Services.AddMasaBlazor();
     builder.Services.Configure<TodoCallerOptions>(builder.Configuration.GetSection("TodoCaller"));
     builder.Services.AddAutoRegistrationCaller(typeof(Program).Assembly);
     
     var app = builder.Build();
     
     if (!app.Environment.IsDevelopment())
     {
         // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
         app.UseHsts();
     }
     
     app.UseHttpsRedirection();
     
     app.UseStaticFiles();
     
     app.UseRouting();
     
     app.MapBlazorHub();
     app.MapFallbackToPage("/_Host");
     
     app.Run();
     ```

   
   
   
## å®šä¹‰å®ä½“

   æˆ‘ä»¬åœ¨**```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„Entitiesæ–‡ä»¶å¤¹ä¸­å®šä¹‰ä¸€ä¸ª**```TodoEntity```**å®ä½“ç±»ã€‚ä»¥åŠä¸€ä¸ª**```TodoDbContext```**æ•°æ®åº“ä¸Šä¸‹æ–‡

   ```c#
   using Masa.BuildingBlocks.Ddd.Domain.Entities;
   
   namespace Masa.TodoApp.WebApi.Entities;
   
   public class TodoEntity : Entity<Guid>
   {
       public string Title { get; set; }
       public bool Done { get; set; }
   }
   
   ```

   ```c#
   using Microsoft.EntityFrameworkCore;
   
   namespace Masa.TodoApp.WebApi.Entities;
   
   public class TodoDbContext : MasaDbContext
   {
       public DbSet<TodoEntity> Todos { get; set; }
   
       public TodoDbContext(MasaDbContextOptions<TodoDbContext> options) : base(options)
       {
       }
   
       protected override void OnModelCreatingConfigureGlobalFilters(ModelBuilder modelBuilder)
       {
           base.OnModelCreatingConfigureGlobalFilters(modelBuilder);
   
           ConfigEntities(modelBuilder);
       }
   
       private static void ConfigEntities(ModelBuilder modelBuilder)
       {
           var todoBuilder = modelBuilder.Entity<TodoEntity>();
           todoBuilder.Property(e => e.Title).HasMaxLength(128);
       }
   }
   
   ```

   ![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329224330496-2123286849.png)

   ## åˆ›å»ºTodoåç«¯æ¥å£æœåŠ¡

   æˆ‘ä»¬çš„TodoAppæ•´ä¸ªä¸šåŠ¡å¤§æ¦‚éœ€è¦æœ‰ä»¥ä¸‹æ¥å£ï¼š

   * Createï¼šåˆ›å»ºä¸€ä¸ªå¾…åŠäº‹é¡¹
   * Updateï¼šä¿®æ”¹ä¸€ä¸ªå¾…åŠäº‹é¡¹
   * Deleteï¼šåˆ é™¤ä¸€ä¸ªå¾…åŠäº‹é¡¹
   * GetListï¼šè·å–å¾…åŠäº‹é¡¹åˆ—è¡¨
   * Doneï¼šå®Œæˆä¸€ä¸ªå¾…åŠäº‹é¡¹

   ### åˆ›å»ºæ¥å£æ‰€éœ€çš„Dto

   æˆ‘ä»¬åœ¨ **```Masa.TodoApp.Contracts```** é¡¹ç›®ä¸­åˆ›å»ºæˆ‘ä»¬æ‰€éœ€è¦çš„Dtoï¼Œä¹‹æ‰€ä»¥åœ¨è¿™é‡Œåˆ›å»ºæ˜¯å› ä¸ºæˆ‘ä»¬æ¥å£å’ŒBlazorå¯ä»¥å…±äº«æ•°æ®æ¨¡å‹ï¼Œè¿™æ ·é¿å…æˆ‘ä»¬å‰ç«¯é¡¹ç›®é‡æ–°å®šä¹‰æ•°æ®æ¨¡å‹

   ```c#
   namespace Masa.TodoApp.Contracts;
   
   public class TodoGetListDto
   {
       public Guid Id { get; set; }
       public string Title { get; set; }
       public bool Done { get; set; }
   }
   ```

   ```c#
   namespace Masa.TodoApp.Contracts;
   
   public class TodoCreateUpdateDto
   {
       public string Title { get; set; }
   }
   ```

   ![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329224244824-1440279168.png)

### åˆ›å»ºCqrsä¸šåŠ¡æœåŠ¡

> åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªcqrsæ¥å®Œæˆæˆ‘ä»¬ä¸šåŠ¡å±‚ï¼Œåœ¨Cqrsæ¨¡å¼ä¸­æˆ‘ä»¬çš„æŸ¥è¯¢å’Œå…¶å®ƒä¸šåŠ¡æ“ä½œæ˜¯åˆ†å¼€çš„ã€‚ä¸äº†è§£Cqrsçš„å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼šhttps://learn.microsoft.com/zh-cn/azure/architecture/patterns/cqrs

1. æˆ‘ä»¬å…ˆåœ¨**```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„ Application\Commandsç›®å½•ä¸­åˆ›å»ºæˆ‘ä»¬çš„ä¸šåŠ¡å‘½ä»¤ï¼š**```CreateTodoCommand.cs```** ã€**```UpdateTodoCommand.cs```** ã€**```DeleteTodoCommand.cs```** ã€**```DoneTodoCommand.cs```** 

```c#
using Masa.BuildingBlocks.ReadWriteSplitting.Cqrs.Commands;
using Masa.TodoApp.Contracts;

namespace Masa.TodoApp.WebApi.Application.Commands;

public record CreateTodoCommand(TodoCreateUpdateDto Dto) : Command { }
```

```c#
using Masa.BuildingBlocks.ReadWriteSplitting.Cqrs.Commands;
using Masa.TodoApp.Contracts;

namespace Masa.TodoApp.WebApi.Application.Commands;

public record UpdateTodoCommand(Guid Id, TodoCreateUpdateDto Dto) : Command { }
```

```c#
using Masa.BuildingBlocks.ReadWriteSplitting.Cqrs.Commands;

namespace Masa.TodoApp.WebApi.Application.Commands;

public record DeleteTodoCommand(Guid Id) : Command { }
```

```c#
using Masa.BuildingBlocks.ReadWriteSplitting.Cqrs.Commands;

namespace Masa.TodoApp.WebApi.Application.Commands; 

public record DoneTodoCommand(Guid Id, bool Done) : Command { }
```



2. æˆ‘ä»¬å†åœ¨**```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„ **Application\Queries**ç›®å½•ä¸­åˆ›å»ºæˆ‘ä»¬çš„æŸ¥è¯¢æŒ‡ä»¤ï¼š**```TodoGetListQuery.cs```**

```c#
using Masa.BuildingBlocks.ReadWriteSplitting.Cqrs.Queries;
using Masa.TodoApp.Contracts;

namespace Masa.TodoApp.WebApi.Application.Queries;

public record TodoGetListQuery : Query<List<TodoGetListDto>>
{
    public override List<TodoGetListDto> Result { get; set; }
}
```

3. ç„¶ååœ¨ Applicationç›®å½•ä¸­åˆ›å»ºæˆ‘ä»¬çš„æŒ‡ä»¤å¤„ç†ç±»ï¼š **```TodoQueryHandler.cs```**  **```TodoCommandHandler.cs```** 

```c#
using Mapster;
using Masa.Contrib.Dispatcher.Events;
using Masa.TodoApp.Contracts;
using Masa.TodoApp.WebApi.Application.Queries;
using Masa.TodoApp.WebApi.Entities;
using Microsoft.EntityFrameworkCore;

namespace Masa.TodoApp.WebApi.Application;

public class TodoQueryHandler
{
    readonly TodoDbContext _todoDbContext;
    public TodoQueryHandler(TodoDbContext todoDbContext) => _todoDbContext = todoDbContext;

    [EventHandler]
    public async Task GetListAsync(TodoGetListQuery query)
    {
        var todoDbQuery = _todoDbContext.Set<TodoEntity>().AsNoTracking();
        query.Result = await todoDbQuery.Select(e => e.Adapt<TodoGetListDto>()).ToListAsync();
    }
}

```



```c#
using Mapster;
using Masa.Contrib.Dispatcher.Events;
using Masa.TodoApp.WebApi.Application.Commands;
using Masa.TodoApp.WebApi.Entities;
using Microsoft.EntityFrameworkCore;

namespace Masa.TodoApp.WebApi.Application;

public class TodoCommandHandler
{
    readonly TodoDbContext _todoDbContext;
    public TodoCommandHandler(TodoDbContext todoDbContext) => _todoDbContext = todoDbContext;

    [EventHandler]
    public async Task CreateAsync(CreateTodoCommand command)
    {
        await ValidateAsync(command.Dto.Title);
        var todo = command.Dto.Adapt<TodoEntity>();
        await _todoDbContext.Set<TodoEntity>().AddAsync(todo);
        await _todoDbContext.SaveChangesAsync();
    }

    [EventHandler]
    public async Task UpdateAsync(UpdateTodoCommand command)
    {
        await ValidateAsync(command.Dto.Title, command.Id);
        var todo = await _todoDbContext.Set<TodoEntity>().AsNoTracking().FirstOrDefaultAsync(t => t.Id == command.Id);
        if (todo == null)
        {
            throw new UserFriendlyException("ä»£åŠä¸å­˜åœ¨");
        }
        command.Dto.Adapt(todo);
        _todoDbContext.Set<TodoEntity>().Update(todo);
        await _todoDbContext.SaveChangesAsync();
    }

    private async Task ValidateAsync(string title, Guid? id = null)
    {
        var todo = await _todoDbContext.Set<TodoEntity>().AsNoTracking().FirstOrDefaultAsync(t => t.Title == title && t.Id != id);
        if (todo != null)
            throw new UserFriendlyException("ä»£åŠå·²å­˜åœ¨");
    }

    [EventHandler]
    public async Task DeleteAsync(DeleteTodoCommand command)
    {
        var todo = await _todoDbContext.Set<TodoEntity>().AsNoTracking().FirstOrDefaultAsync(t => t.Id == command.Id);
        if (todo == null)
        {
            return;
        }
        _todoDbContext.Set<TodoEntity>().Remove(todo);
        await _todoDbContext.SaveChangesAsync();
    }

    [EventHandler]
    public async Task DoneAsync(DoneTodoCommand command)
    {
        var todo = await _todoDbContext.Set<TodoEntity>().AsNoTracking().FirstOrDefaultAsync(t => t.Id == command.Id);
        if (todo == null)
        {
            return;
        }
        todo.Done = command.Done;
        _todoDbContext.Set<TodoEntity>().Update(todo);
        await _todoDbContext.SaveChangesAsync();
    }
}
```

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329230247455-1609076484.png)

### åˆ›å»ºMinimalApiæ¥å£

åœ¨**```Masa.TodoApp.WebApi```**  é¡¹ç›®ä¸‹çš„ Servicesç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªTodoService.csæ¥å£æœåŠ¡

```c#
using Masa.BuildingBlocks.Dispatcher.Events;
using Masa.TodoApp.Contracts;
using Masa.TodoApp.WebApi.Application.Commands;
using Masa.TodoApp.WebApi.Application.Queries;
using Masa.Utils.Models;
using Microsoft.AspNetCore.Mvc;

namespace Masa.TodoApp.WebApi.Services;

public class TodoService : ServiceBase
{
    public TodoService()
    {
        App.MapPost("api/v1/todoes/done", DoneAsync);
    }

    public async Task<List<TodoGetListDto>> GetListAsync(IEventBus eventBus)
    {
        var todoQuery = new TodoGetListQuery();
        await eventBus.PublishAsync(todoQuery);
        return todoQuery.Result;
    }

    public async Task CreateAsync(IEventBus eventBus, TodoCreateUpdateDto dto)
    {
        var command = new CreateTodoCommand(dto);
        await eventBus.PublishAsync(command);
    }

    public async Task UpdateAsync(IEventBus eventBus, Guid id, TodoCreateUpdateDto dto)
    {
        var command = new UpdateTodoCommand(id, dto);
        await eventBus.PublishAsync(command);
    }

    public async Task DeleteAsync(IEventBus eventBus, Guid id)
    {
        var command = new DeleteTodoCommand(id);
        await eventBus.PublishAsync(command);
    }

    public async Task DoneAsync(IEventBus eventBus, [FromQuery] Guid id, [FromQuery] bool done)
    {
        var command = new DoneTodoCommand(id, done);
        await eventBus.PublishAsync(command);
    }
}
```

### ä¿®æ”¹ Program.csç±»ä»¥åŠappsetting.jsoné…ç½®

æœ€åæˆ‘ä»¬ä¿®æ”¹ä¸‹Program.csç±»ï¼Œé…ç½®æ•´ä¸ªæ¥å£æœåŠ¡ã€‚ä»¥åŠå‘appsetting.jsonæ·»åŠ æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é…ç½®

```c#
using Microsoft.EntityFrameworkCore.Storage;
using Microsoft.EntityFrameworkCore;
using Microsoft.OpenApi.Models;
using Masa.TodoApp.WebApi.Entities;
using Microsoft.EntityFrameworkCore.Infrastructure;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddEventBus();
builder.Services.AddMasaDbContext<TodoDbContext>(opt => opt.UseSqlite());
builder.Services.AddMasaMinimalAPIs();
//Swaggerä¾èµ–Endpointçš„ä¸€äº›æœåŠ¡ï¼Œå¿…é¡»AddEndpointsApiExplorerï¼Œä¸ç„¶swaggerä¸èƒ½ä½¿ç”¨
builder.Services.AddEndpointsApiExplorer()
    .AddSwaggerGen(c =>
    {
        c.SwaggerDoc("v1", new OpenApiInfo
        {
            Title = "TodoApp",
            Version = "v1",
            Contact = new OpenApiContact { Name = "TodoApp", }
        });

        foreach (var item in Directory.GetFiles(Directory.GetCurrentDirectory(), "*.xml"))
        {
            c.IncludeXmlComments(item, true);
        }
        c.DocInclusionPredicate((docName, action) => true);
    });
builder.Services.AddAutoInject();
var app = builder.Build();

app.UseMasaExceptionHandler();
app.MapMasaMinimalAPIs();
#region MigrationDb
using var context = app.Services.CreateScope().ServiceProvider.GetService<TodoDbContext>();
{
    if (context!.GetService<IRelationalDatabaseCreator>().HasTables() == false)
    {
        context!.GetService<IRelationalDatabaseCreator>().CreateTables();
    }
}
#endregion
app.UseSwagger().UseSwaggerUI(c => c.SwaggerEndpoint("/swagger/v1/swagger.json", "TodoApp"));
app.Run();
```

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Data Source=demodb.sqlite"
  }
}

```

æœ€ç»ˆæˆ‘ä»¬çš„æ¥å£æœåŠ¡å°±å®Œæˆäº†ï¼Œæˆ‘ä»¬æ¥å¯åŠ¨ä¸‹åç«¯æ¥å£æœåŠ¡ï¼Œå¹¶è®¿é—®/swagger

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329231627727-626170557.png)



## åˆ›å»ºTodoå‰ç«¯ç•Œé¢

æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¦å¼€å§‹ç¼–å†™æˆ‘ä»¬çš„å‰ç«¯webç•Œé¢äº†ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘ä»¬å†çœ‹ä¸‹æˆ‘ä»¬çš„webå‰ç«¯æœ€ç»ˆæ•ˆæœå›¾

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230328231628904-1957534939.png)

### åˆ›å»ºæ¥å£æœåŠ¡è°ƒç”¨

>  é¦–å…ˆæˆ‘ä»¬çš„webç•Œé¢éœ€è¦è°ƒç”¨åç«¯æ¥å£æ¥è·å–æ•°æ®ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºåç«¯æ¥å£æœåŠ¡è°ƒç”¨ï¼Œç›¸ä¿¡è¿™å—å°†æ¯”å…¶å®ƒå‰ç«¯æ¡†æ¶è°ƒç”¨æ¥å£æ›´åŠ ç®€å•

æˆ‘ä»¬ä¿®æ”¹ **```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹çš„ApiCallersç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºTodoServiceOptions.cså’ŒTodoCaller.csï¼Œå‰è€…æ˜¯todoåç«¯æœåŠ¡çš„é…ç½®ï¼Œåè€…æ˜¯æ¥å£è°ƒç”¨

```c#
namespace Masa.TodoApp.WebBalzor.ApiCallers;

public class TodoServiceOptions
{
    public string BaseAddress { get; set; }
}
```

```c#
using Masa.Contrib.Service.Caller.HttpClient;
using Masa.TodoApp.Contracts;
using Microsoft.Extensions.Options;

namespace Masa.TodoApp.WebBalzor.ApiCallers;

public class TodoCaller : HttpClientCallerBase
{
    private readonly string _prefix = "/api/v1/todoes";
    protected override string BaseAddress { get; set; }

    public TodoCaller(IOptions<TodoServiceOptions> options)
    {
        BaseAddress = options.Value.BaseAddress;
    }

    public async Task<List<TodoGetListDto>> GetListAsync()
    {
        var result = await Caller.GetAsync<List<TodoGetListDto>>($"{_prefix}/list");
        return result ?? new();
    }

    public async Task CreateAsync(TodoCreateUpdateDto dto)
    {
        var result = await Caller.PostAsync($"{_prefix}", dto);
    }

    public async Task UpdateAsync(Guid id, TodoCreateUpdateDto dto)
    {
        var result = await Caller.PutAsync($"{_prefix}/{id}", dto);
    }

    public async Task DeleteAsync(Guid id)
    {
        var result = await Caller.DeleteAsync($"{_prefix}/{id}", null);
    }

    public async Task DoneAsync(Guid id, bool done)
    {
        var result = await Caller.PostAsync($"{_prefix}/done?id={id}&done={done.ToString().ToLower()}", null);
    }
}
```

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329235247591-1375798590.png)

### æ·»åŠ Masa.Blazorå’Œæ¥å£è°ƒç”¨æœåŠ¡

ä¸‹ä¸€æ­¥å°±æ˜¯æ·»åŠ æˆ‘ä»¬çš„**Masa.Blazor**æœåŠ¡ä»¥åŠåç«¯æ¥å£è°ƒç”¨æœåŠ¡ï¼Œä¿®æ”¹ **```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸­çš„**```Program.cs```**æ–‡ä»¶

```c#
using Masa.TodoApp.WebBalzor.ApiCallers;

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddRazorPages();
builder.Services.AddServerSideBlazor();
builder.Services.AddMasaBlazor();
builder.Services.Configure<TodoServiceOptions>(builder.Configuration.GetSection("TodoService"));
builder.Services.AddAutoRegistrationCaller(typeof(Program).Assembly);

var app = builder.Build();
if (!app.Environment.IsDevelopment())
{
    app.UseHsts();
}
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.MapBlazorHub();
app.MapFallbackToPage("/_Host");
app.Run();
```

åœ¨è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹appsetting.jsoné…ç½®æ–‡ä»¶ä»¥ä¾¿æ·»åŠ æˆ‘ä»¬çš„æ¥å£æœåŠ¡åœ°å€ï¼š

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "TodoService": {
    "BaseAddress": "your interface service address" //example  http://localhost:6001
  }
}
```

### å¼•å…¥Masa.Blazorç»„ä»¶

æˆ‘ä»¬ä¿®æ”¹ **```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹çš„**Pages**ç›®å½•ä¸­çš„**```_Host.cshtml```**æ–‡ä»¶ï¼Œå¼•å…¥**Masa.Blazor**çš„æ ·å¼

```html
@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace Masa.TodoApp.WebBalzor.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <base href="~/" />
    <link href="css/site.css" rel="stylesheet" />
    <!-- masa blazor css style -->
    <link href="_content/Masa.Blazor/css/masa-blazor.min.css" rel="stylesheet" />

    <!--icon file,import need to use-->
    <link href="https://cdn.masastack.com/npm/@("@mdi")/font@7.1.96/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.masastack.com/npm/materialicons/materialicons.css" rel="stylesheet">
    <link href="https://cdn.masastack.com/npm/fontawesome/v5.0.13/css/all.css" rel="stylesheet">

    <!--js(should lay the end of file)-->
    <script src="_content/BlazorComponent/js/blazor-component.js"></script>
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            An error has occurred. This application may no longer respond until reloaded.
        </environment>
        <environment include="Development">
            An unhandled exception has occurred. See browser dev tools for details.
        </environment>
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ğŸ—™</a>
    </div>

    <script src="_framework/blazor.server.js"></script>
</body>
</html>
```

ç„¶ååœ¨ **```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹çš„ **```_Imports.razor```** æ–‡ä»¶ä¸­å¼•å…¥**Masa.Blazor**çš„å‘½åç©ºé—´

```c#
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Masa.TodoApp.WebBalzor
@using Masa.Blazor
@using BlazorComponent
```

### å®ç°UIç•Œé¢

>  æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹ç¼–å†™æˆ‘ä»¬çš„ç•Œé¢äº†

* ä¿®æ”¹**```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹**```MainLayout.razor```**æ–‡ä»¶

```c#
@inherits LayoutComponentBase

<MApp> @Body </MApp>
```

* ä¿®æ”¹ **```Masa.TodoApp.WebBalzor```** é¡¹ç›®ä¸‹ **Pages** ç›®å½•ä¸­çš„ **```Index.razor```** æ–‡ä»¶

```html
@page "/"
@using Masa.TodoApp.Contracts;
@using Masa.TodoApp.WebBalzor.ApiCallers;
<MContainer Style="max-width: 500px">

    <MTextField @bind-Value="_newTodo"
                Label="What are you working on?"
                Solo
                OnKeyDown="OnEnterKeyDown">
        <AppendContent>
            <FadeTransition>
                <MIcon If="@(!string.IsNullOrEmpty(_newTodo))"
                       OnClick="()=>Create()">
                    add_circle
                </MIcon>
            </FadeTransition>
        </AppendContent>
    </MTextField>

    <h2 class="text-h4 success--text pl-4">
        Tasks:&nbsp;
        <FadeTransition LeaveAbsolute>
            <KeyTransitionElement Tag="span" Value="@($"task-{_tasks.Count}")">
                @_tasks.Count
            </KeyTransitionElement>
        </FadeTransition>
    </h2>

    <MDivider></MDivider>

    <MRow Class="my-1" Align=AlignTypes.Center>

        <strong class="mx-4 info--text text--darken-2">
            Remaining: @RemainingTasks
        </strong>
        <MDivider Vertical></MDivider>
        <strong class="mx-4 success--text text--darken-2">
            Completed: @CompletedTasks
        </strong>
        <MSpacer></MSpacer>
        <MProgressCircular Value=Progress Class="mr-2"></MProgressCircular>
    </MRow>

    <MDivider Class="mb-4"></MDivider>

    @if (_tasks.Count > 0)
    {
        <MCard>
            <SlideYTransition>
                @for (var i = 0; i < _tasks.Count; i++)
                {
                    var task = _tasks[i];
                    if (i != 0)
                    {
                        <MDivider></MDivider>
                    }
                    <MListItem>
                        @if (editorTodoId == task.Id)
                        {
                            <MTextField Color="purple darken-2" @bind-Value="_updateTodo"></MTextField>
                        }
                        else
                        {
                            <MListItemAction>
                                <MCheckbox TValue="bool" Value="@task.Done"
                               ValueChanged="@(v => Done(task.Id,v))"
                               Color="@(task.Done ? "grey" : "primary")">
                                    <LabelContent>
                                        <div class="@(task.Done ? "grey--text" : "primary--text") ml-4">
                                            @task.Title
                                        </div>
                                    </LabelContent>
                                </MCheckbox>
                            </MListItemAction>
                        }

                        <MSpacer></MSpacer>
                        <MButton Icon Show="@(task.Done==false&&editorTodoId!=task.Id)" OnClick="()=>{editorTodoId=task.Id;_updateTodo=task.Title;}">
                            <MIcon>mdi-pencil</MIcon>
                        </MButton>

                        <MButton Outlined Small Show="@(editorTodoId==task.Id)" OnClick="()=>Update(task)" Color="success" Class="mr-2">
                            ok
                        </MButton>
                        <MButton Outlined Small Show="@(editorTodoId==task.Id)" OnClick="()=>editorTodoId=null">
                            canel
                        </MButton>

                        <MButton Icon Show="@(editorTodoId!=task.Id)" OnClick="()=>Delete(task.Id)" Color="error">
                            <MIcon>mdi-delete</MIcon>
                        </MButton>
                        <ScrollXTransition>
                            <MIcon If="@task.Done" Color="success">
                                mdi-check
                            </MIcon>
                        </ScrollXTransition>
                    </MListItem>
                }
            </SlideYTransition>
        </MCard>
    }

</MContainer>

@code {

    [Inject]
    public TodoCaller TodoCaller { get; set; }

    string _newTodo = "";
    string _updateTodo = "";

    private List<TodoGetListDto> _tasks = new();

    int CompletedTasks => _tasks.Count(t => t.Done);

    float Progress => _tasks.Count <= 0 ? 0 : (CompletedTasks * 100f) / _tasks.Count;

    int RemainingTasks => _tasks.Count - CompletedTasks;

    Guid? editorTodoId;

    async Task OnEnterKeyDown(KeyboardEventArgs eventArgs)
    {
        if (eventArgs.Key == "Enter")
        {
            await Create();
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadListDataAsync();
    }

    private async Task LoadListDataAsync()
    {
        var result = await TodoCaller.GetListAsync();
        _tasks = result;
    }

    async Task Create()
    {
        await TodoCaller.CreateAsync(new TodoCreateUpdateDto { Title = _newTodo });

        await LoadListDataAsync();
        _newTodo = "";
    }

    async Task Done(Guid id, bool done)
    {
        await TodoCaller.DoneAsync(id, done);
        await LoadListDataAsync();
    }

    async Task Update(TodoGetListDto task)
    {
        await TodoCaller.UpdateAsync(task.Id, new TodoCreateUpdateDto { Title = _updateTodo });
        await LoadListDataAsync();
        editorTodoId = null;
    }

    async Task Delete(Guid id)
    {
        await TodoCaller.DeleteAsync(id);
        await LoadListDataAsync();
        editorTodoId = null;
    }
}
```

## æœ€ç»ˆæ•ˆæœ

![](https://img2023.cnblogs.com/blog/1525201/202303/1525201-20230329235135545-661469102.png)
