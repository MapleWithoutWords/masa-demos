# Masa Framework源码解读-EventBus（可编排+拦截的事件总线）

## 序言

这篇文章我们来看下 ```Masa Framework``` 的事件总线。 ```Masa Framework``` 的事件总线不同于其它的事件总线框架， ```Masa Framework``` 在事件总线基本的发布订阅功能之外，它还支持**事件编排**和**事件拦截**，从而避免我们的流水账似的编程，降低系统维护难度。

## 简介

 ```Masa Framework``` 中的事件总线支持 **进程内事件总线** (进程内事件的意思就是在我们应用程序进程内)和 **分布式事件总线** ，同时 ```Masa Framework``` 的事件总线也是可以在我们的框架程序中单独安装使用。最有特点的是 ```Masa Framework``` 的事件总线支持 **事件编排** 和 **事件拦截** ，首先**事件编排**允许你**设置事件处理的执行顺序**，而**事件拦截**允许你发布事件的时候可以**拦截事件** 。那么这两个功能有什么厉害之处呢？下面我们来看某个实际业务中的场景

* 场景：在一个业务系统中用户的权限信息很少会变动，避免每次检查用户权限的时候都需要读取数据，我们就需要给用户权限增加缓存。那么就会出现以下这种**流水账似的代码逻辑**。每次操作完用户、角色、权限等信息都在原有逻辑上增加缓存，下次再增加其它操作例如授权日志的时候，又在后面追加。随着业务变得复杂，我们的代码也越来越复杂，经常出现一个方法 **500行以上的代码** ，甚至过之而不及（PS：我见过最多的是一个方法5000行，全是解析规则的逻辑）。这对于系统的 **后期维护以及扩展性极其不利** 。

```c#
public async Task CreateAsync(UserCreateDto dto)
{
    //新增用户以及用户权限、用户角色等

    //：添加用户缓存
}

public async Task UpdateAsync(UserUpdateDto dto)
{
    //修改用户以及用户权限、用户角色等

    //：修改用户缓存
    //：日志
    //：消息推送
}
```

对于这种流水账似的编程，```Masa Framework``` 是怎么解决的？

 ## EventBus使用

针对以上场景，例如：修改用户这个逻辑，我们来看下MasaFramework的EventBus解决思路。首先先对整个逻辑进行划分，我们可以粗略划分为以下几个逻辑：

1. 新增用户、用户角色、用户权限等信息
2. 修改用户缓存
3. 添加修改日志
4. 消息通知相关方

然后将各个逻辑放到各个模块自己的内部，话不多说，我们进入到编码环节

### 安装



